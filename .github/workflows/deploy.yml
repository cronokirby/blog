name: Deploy to GitHub Pages

permissions:
    contents: write

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      # Cache NAR of the external clog builder
      - name: Cache clog NAR
        id: nar-cache
        uses: actions/cache@v5
        with:
          path: clog-builder.nar
          key: ${{ runner.os }}-clog-builder-nar-${{ hashFiles('flake.lock') }}
          restore-keys: |
            ${{ runner.os }}-clog-builder-nar-

      - name: Restore clog from NAR if present
        if: steps.nar-cache.outputs.cache-hit == 'true'
        run: |
          echo "Restoring clog builder from NAR..."
          nix-store --import < clog-builder.nar

      - name: Build clog if needed
        if: steps.nar-cache.outputs.cache-hit != 'true'
        run: |
          echo "Building clog..."
          # Evaluate the store path of the builder in the external flake
          STORE_PATH=$(nix eval github:cronokirby/clog --raw)
          # Build it
          nix build github:cronokirby/clog
          # Export its store paths (including dependencies) to a NAR
          nix-store --export $(nix-store -qR $STORE_PATH) > clog-builder.nar

      - name: Build site
        run: nix build .

      - name: Deploy to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          # Configure git
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          # Create a temporary directory for the gh-pages branch
          tmpdir=$(mktemp -d)
          git clone --branch gh-pages "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$tmpdir" || \
            git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$tmpdir" && git checkout --orphan gh-pages

          # Clear old files
          rm -rf "$tmpdir"/*

          # Copy new site
          cp -r result/* "$tmpdir"

          cd "$tmpdir"
          git add .
          git commit -m "Deploy site from GitHub Actions"
          git push --force
